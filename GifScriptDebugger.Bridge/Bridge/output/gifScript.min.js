Bridge.assembly("GifScriptDebugger.Bridge",function(){"use strict";Bridge.define("GifScript.ColorRGB",{$kind:"struct",statics:{config:{init:function(){this.black=new GifScript.ColorRGB.$ctor1(0,0,0);this.white=new GifScript.ColorRGB.$ctor1(255,255,255)}},makePalette:function(table){for(var tab=System.Array.init(Bridge.Int.div(table.length,3)|0,function(){return new GifScript.ColorRGB},GifScript.ColorRGB),i=0,j=0;i<table.length;){var r=table[Bridge.identity(i,i=i+1|0)],g=table[Bridge.identity(i,i=i+1|0)],b=table[Bridge.identity(i,i=i+1|0)],c=new GifScript.ColorRGB.$ctor1(r,g,b);tab[Bridge.identity(j,j=j+1|0)]=c.$clone()}return tab},op_Addition:function(lhs,rhs){return new GifScript.ColorRGB.$ctor1((lhs.r+rhs.r|0)&255,(lhs.g+rhs.g|0)&255,(lhs.b+rhs.b|0)&255)},op_Equality:function(lhs,rhs){return lhs.r===rhs.r&&lhs.g===rhs.g&&lhs.b===rhs.b},op_Inequality:function(lhs,rhs){return lhs.r!==rhs.r||lhs.g!==rhs.g||lhs.b!==rhs.b},getDefaultValue:function(){return new GifScript.ColorRGB}},r:0,g:0,b:0,R16:0,G16:0,B16:0,$ctor1:function(r,g,b){this.$initialize();this.r=r;this.g=g;this.b=b;this.R16=(Bridge.Int.div(r,16)|0)&255;this.G16=(Bridge.Int.div(g,16)|0)&255;this.B16=(Bridge.Int.div(b,16)|0)&255},ctor:function(){this.$initialize()},gethexSignature:function(){return((this.R16<<8)+(this.G16<<4)|0)+this.B16|0},equals:function(other){return GifScript.ColorRGB.op_Equality(this,other)},isBlack:function(){return this.r===0&&this.g===0&&this.b===0},getAdjacentRGColors:function(){var result=new(System.Collections.Generic.List$1(GifScript.ColorRGB));return this.r>0&&result.add(new GifScript.ColorRGB.$ctor1((this.r-1|0)&255,this.g,this.b)),this.r<255&&result.add(new GifScript.ColorRGB.$ctor1((this.r+1|0)&255,this.g,this.b)),this.g>0&&result.add(new GifScript.ColorRGB.$ctor1(this.r,(this.g-1|0)&255,this.b)),this.g<255&&result.add(new GifScript.ColorRGB.$ctor1(this.r,(this.g+1|0)&255,this.b)),result},increment:function(overflow){return this.R16<15?(overflow.v=!1,new GifScript.ColorRGB.$ctor1((17*(this.R16+1|0)|0)&255,this.g,this.b)):this.G16<15?(overflow.v=!1,new GifScript.ColorRGB.$ctor1(0,(17*(this.G16+1|0)|0)&255,this.b)):this.B16<15?(overflow.v=!1,new GifScript.ColorRGB.$ctor1(0,0,(17*(this.B16+1|0)|0)&255)):(overflow.v=!0,new GifScript.ColorRGB.ctor)},getOffsetTo:function(next){return((next.r-this.r|0)+((next.g-this.g|0)*255|0)|0)+(((next.b-this.b|0)*255|0)*255|0)|0},addOffset:function(offset,overflow){var newR=this.r,newG=this.g,newB=this.b,addB,addG;if(offset>65025)if(addB=Bridge.Int.div(offset,65025)|0,offset=offset-((addB*255|0)*255|0)|0,(newB+addB|0)<=255)newB=(newB+addB|0)&255;else return overflow.v=!0,GifScript.ColorRGB.black.$clone();if(offset>255)if(addG=Bridge.Int.div(offset,255)|0,offset=offset-(addG*255|0)|0,(newG+addG|0)<=255)newG=(newG+addG|0)&255;else if(newB<255)newG=((newG+addG|0)-255|0)&255,newB=newB+1&255;else return overflow.v=!0,GifScript.ColorRGB.black.$clone();if((newR+offset|0)<=255)newR=(newR+offset|0)&255;else if(newR=((newR+offset|0)-255|0)&255,newG<255)newG=newG+1&255;else if(newB<255)newG=0,newB=newB+1&255;else return overflow.v=!0,GifScript.ColorRGB.black.$clone();return overflow.v=!1,new GifScript.ColorRGB.$ctor1(newR,newG,newB)},getHashCode:function(){return Bridge.addHash([2981347765,this.r,this.g,this.b,this.R16,this.G16,this.B16])},$clone:function(to){var s=to||new GifScript.ColorRGB;return s.r=this.r,s.g=this.g,s.b=this.b,s.R16=this.R16,s.G16=this.G16,s.B16=this.B16,s}});Bridge.define("GifScript.GifCube",{slices:null,config:{init:function(){this.slices=System.Array.init(16,null,GifScript.GifCubeSlice)}},ctor:function(){this.$initialize()},$ctor1:function(decoder){this.$initialize();for(var frameIdx=0;frameIdx<decoder.length&&frameIdx<16;frameIdx=frameIdx+1&255)this.addFrame(frameIdx,new GifScript.GifCubeSlice.$ctor2(decoder[frameIdx]))},getItem:function(index){return this.slices[index.B16]!=null?this.slices[index.B16].getItem(index):GifScript.ColorRGB.black.$clone()},setItem:function(index,value){this.slices[index.B16]==null&&this.addFrame(index.B16,new GifScript.GifCubeSlice.ctor);this.slices[index.B16].setItem(index,value.$clone())},addFrame:function(T,slice){this.slices[T]=slice}});Bridge.define("GifScript.GifCubeSlice",{pixels:null,config:{init:function(){this.pixels=System.Array.create(new GifScript.ColorRGB,null,GifScript.ColorRGB,16,16)}},ctor:function(){this.$initialize()},$ctor2:function(image){var x,y,item;for(this.$initialize(),x=0;x<16;x=x+1|0)for(y=0;y<16;y=y+1|0)item=image[x+(y*16|0)|0],this.pixels.set([x,y],new GifScript.ColorRGB.$ctor1(item[0],item[1],item[2]))},$ctor1:function(indexedPixels,width,palette){var $t,x,y,p;for(this.$initialize(),x=0,y=0,$t=Bridge.getEnumerator(indexedPixels);$t.moveNext();)if(p=$t.getCurrent(),x<16&&this.pixels.set([x,y],palette[p].$clone()),x=Bridge.Int.sxs(x+1&65535),x===width&&(x=0,y=Bridge.Int.sxs(y+1&65535)),y>=16)break},getItem:function(index){return this.pixels.get([index.R16,index.G16]).$clone()},setItem:function(index,value){this.pixels.set([index.R16,index.G16],value.$clone())},getItem$1:function(X,Y){return this.pixels.get([X,Y]).$clone()},setItem$1:function(X,Y,value){this.pixels.set([X,Y],value.$clone())}});Bridge.define("GifScript.IGifValue",{$kind:"interface"});Bridge.define("GifScript.GifScriptState",{registerPositions:null,registerTargets:null,overflowTryOrder:null,config:{properties:{runningRegister:null,current:null,stack:null,halted:!1},init:function(){this.registerPositions=new GifScript.GifCube.ctor;this.registerTargets=System.Array.create(null,null,GifScript.GifCube,16,16,16);this.overflowTryOrder=System.Array.init([1,0,2],System.Int32);this.runningRegister=new GifScript.ColorRGB}},init:function(program){var x,y,z;for(this.setstack(new(System.Collections.Generic.Stack$1(GifScript.GifStackFrame).ctor)),x=0;x<16;x=x+1|0)for(y=0;y<16;y=y+1|0)for(z=0;z<16;z=z+1|0)this.registerTargets.set([x,y,z],new GifScript.GifCube.ctor);this.setrunningRegister(GifScript.ColorRGB.white.$clone());this.registerTargets.set([this.getrunningRegister().R16,this.getrunningRegister().G16,this.getrunningRegister().B16],program);this.registerTargets.set([8,8,8],this.registerPositions);this.setcurrent(new GifScript.GifValue_Readonly(GifScript.ColorRGB.black.$clone()));this.sethalted(!1)},getRegisterTarget:function(register){return this.registerTargets.get([register.R16,register.G16,register.B16])},getRegisterPosition:function(register){return this.registerPositions.getItem(register)},tick:function(){var failed;if(!this.gethalted()){var programPosition=this.registerPositions.getItem(this.getrunningRegister()).$clone(),program=this.getRegisterTarget(this.getrunningRegister().$clone()),instruction=program.getItem(programPosition).$clone(),currentColor=this.getcurrent().GifScript$IGifValue$read().$clone(),overflow={};if(this.registerPositions.setItem(this.getrunningRegister(),this.registerPositions.getItem(this.getrunningRegister()).increment(overflow).$clone()),overflow.v){this.sethalted(!0);return}switch(instruction.gethexSignature()){case 0:this.doReturn(this.getcurrent());break;case 3276:this.getstack().push(new GifScript.GifStackFrame.$ctor1(this.getcurrent(),3276,this.getrunningRegister().$clone()));break;case 3212:this.getstack().push(new GifScript.GifStackFrame.$ctor1(this.getcurrent(),3212,this.getrunningRegister().$clone()));break;case 3076:break;case 3204:break;case 3268:this.getstack().push(new GifScript.GifStackFrame.$ctor1(this.getcurrent(),3268,this.getrunningRegister().$clone()));break;case 12:this.setcurrent(new GifScript.GifCursor(currentColor.$clone(),currentColor.$clone(),this.registerPositions));break;case 140:this.setcurrent(new GifScript.GifCursor(currentColor.$clone(),this.registerPositions.getItem(currentColor),this.registerTargets.get([currentColor.R16,currentColor.G16,currentColor.B16])));break;case 204:this.setcurrent(new GifScript.GifCursor(GifScript.ColorRGB.white.$clone(),currentColor.$clone(),this.registerTargets.get([15,15,15])));break;case 3084:failed={};this.registerPositions.setItem(this.getrunningRegister(),GifScript.ColorRGB.op_Addition(this.registerPositions.getItem(this.getrunningRegister()),new GifScript.ColorRGB.$ctor1(48,0,0)));this.setcurrent(this.modify(currentColor.$clone(),System.Array.init([program.getItem(GifScript.ColorRGB.op_Addition(programPosition,new GifScript.ColorRGB.$ctor1(16,0,0))),program.getItem(GifScript.ColorRGB.op_Addition(programPosition,new GifScript.ColorRGB.$ctor1(32,0,0))),program.getItem(GifScript.ColorRGB.op_Addition(programPosition,new GifScript.ColorRGB.$ctor1(48,0,0)))],GifScript.ColorRGB),failed));failed.v&&this.doReturn(this.getcurrent());break;default:this.setcurrent(new GifScript.GifCursor(this.getrunningRegister().$clone(),programPosition.$clone(),program))}}},getRegisterName:function(registerId){return""+String.fromCharCode(this.getHexChar(registerId.R16))+String.fromCharCode(this.getHexChar(registerId.R16))+String.fromCharCode(this.getHexChar(registerId.G16))+String.fromCharCode(this.getHexChar(registerId.G16))+String.fromCharCode(this.getHexChar(registerId.B16))+String.fromCharCode(this.getHexChar(registerId.B16))},getHexChar:function(C16){return"0123456789abcdef".charCodeAt(C16)},doReturn:function(returnValue){var returnFrame,failure,lhsColor,rhsColor;if(this.getstack().getCount()===0){this.sethalted(!0);return}returnFrame=this.getstack().pop();this.setrunningRegister(returnFrame.runningRegister.$clone());switch(returnFrame.rHSInstruction){case 3276:failure={};returnValue.GifScript$IGifValue$write(returnFrame.lHSValue.GifScript$IGifValue$read().$clone(),failure);failure.v&&this.doReturn(returnValue);break;case 3212:this.getstack().push(new GifScript.GifStackFrame.ctor(returnFrame.runningRegister.$clone()));this.setcurrent(returnFrame.lHSValue);this.setrunningRegister(returnValue.GifScript$IGifValue$read().$clone());break;case 3268:lhsColor=returnFrame.lHSValue.GifScript$IGifValue$read().$clone();rhsColor=returnValue.GifScript$IGifValue$read().$clone();this.registerTargets.set([rhsColor.R16,rhsColor.G16,rhsColor.B16],this.registerTargets.get([lhsColor.R16,lhsColor.G16,lhsColor.B16]))}},modify:function(value,modifyExamples,error){for(var Idx=0;Idx<(modifyExamples.length-1|0);Idx=Idx+1|0)if(modifyExamples[Idx].equals(value.$clone()))return error.v=!1,new GifScript.GifValue_Readonly(modifyExamples[Idx+1|0].$clone());var rules=System.Array.init(3,0,GifScript.GifScriptState.ModifyRule),parameters=System.Array.init(3,0,System.Int32),examples=System.Array.init([System.Array.init([modifyExamples[0].r,modifyExamples[1].r,modifyExamples[2].r],System.Byte),System.Array.init([modifyExamples[0].g,modifyExamples[1].g,modifyExamples[2].g],System.Byte),System.Array.init([modifyExamples[0].b,modifyExamples[1].b,modifyExamples[2].b],System.Byte)],System.Array.type(System.Byte));rules[0]=this.deduceModifyRule(examples,0,Bridge.ref(parameters,0));rules[1]=this.deduceModifyRule(examples,1,Bridge.ref(parameters,1));rules[2]=this.deduceModifyRule(examples,2,Bridge.ref(parameters,2));rules[1]===GifScript.GifScriptState.ModifyRule.Unknown&&(rules[1]=this.tryOverflowRule(rules,parameters,examples,1));rules[0]===GifScript.GifScriptState.ModifyRule.Unknown&&(rules[0]=this.tryOverflowRule(rules,parameters,examples,0));rules[2]===GifScript.GifScriptState.ModifyRule.Unknown&&(rules[2]=this.tryOverflowRule(rules,parameters,examples,2));var errorR={},errorG={},errorB={},input=System.Array.init([value.r,value.g,value.b],System.Byte),R=this.applyRule(input,rules,parameters,0,errorR),G=this.applyRule(input,rules,parameters,1,errorG),B=this.applyRule(input,rules,parameters,2,errorB);return error.v=errorR.v||errorG.v||errorB.v,new GifScript.GifValue_Readonly(new GifScript.ColorRGB.$ctor1(R,G,B))},deduceModifyRule:function(examples,channel,parameter){var channelExamples=examples[channel];return channelExamples[0]===channelExamples[1]&&channelExamples[0]===channelExamples[2]?GifScript.GifScriptState.ModifyRule.CopyR+channel|0:channelExamples[1]===examples[0][0]&&channelExamples[2]===examples[0][1]?GifScript.GifScriptState.ModifyRule.CopyR:channelExamples[1]===examples[1][0]&&channelExamples[2]===examples[1][1]?GifScript.GifScriptState.ModifyRule.CopyG:channelExamples[1]===examples[2][0]&&channelExamples[2]===examples[2][1]?GifScript.GifScriptState.ModifyRule.CopyB:channelExamples[1]===channelExamples[2]?(parameter.v=channelExamples[1],GifScript.GifScriptState.ModifyRule.SetConstant):channelExamples[1]===(255-channelExamples[0]|0)&&channelExamples[2]===(255-channelExamples[1]|0)?GifScript.GifScriptState.ModifyRule.Invert:(channelExamples[1]-channelExamples[0]|0)==(channelExamples[2]-channelExamples[1]|0)?(parameter.v=channelExamples[1]-channelExamples[0]|0,GifScript.GifScriptState.ModifyRule.Add):((channelExamples[1]+256|0)-channelExamples[0]|0)%256==((channelExamples[2]+256|0)-channelExamples[1]|0)%256?(parameter.v=((channelExamples[1]+256|0)-channelExamples[0]|0)%256,parameter.v>127?parameter.v=parameter.v-256|0:parameter.v<-128&&(parameter.v=parameter.v+256|0),GifScript.GifScriptState.ModifyRule.Wrap255Add):((channelExamples[1]+272|0)-channelExamples[0]|0)%272==((channelExamples[2]+272|0)-channelExamples[1]|0)%272?(parameter.v=((channelExamples[1]+272|0)-channelExamples[0]|0)%272,parameter.v>127?parameter.v=parameter.v-256|0:parameter.v<-128&&(parameter.v=parameter.v+256|0),GifScript.GifScriptState.ModifyRule.Wrap272Add):GifScript.GifScriptState.ModifyRule.Unknown},applyRule:function(input,rules,parameters,channel,error){var result,result1,result2,result3,result4,result5;error.v=!1;switch(rules[channel]){case GifScript.GifScriptState.ModifyRule.CopyR:return input[0];case GifScript.GifScriptState.ModifyRule.CopyG:return input[1];case GifScript.GifScriptState.ModifyRule.CopyB:return input[2];case GifScript.GifScriptState.ModifyRule.SetConstant:return parameters[channel]&255;case GifScript.GifScriptState.ModifyRule.Invert:return(255-input[channel]|0)&255;case GifScript.GifScriptState.ModifyRule.Add:return result=input[channel]+parameters[channel]|0,(result<0||result>255)&&(error.v=!0),result&255;case GifScript.GifScriptState.ModifyRule.Wrap255Add:return result1=input[channel]+parameters[channel]|0,result1&255;case GifScript.GifScriptState.ModifyRule.Wrap272Add:return result2=input[channel]+parameters[channel]|0,result2%272&255;case GifScript.GifScriptState.ModifyRule.OverflowR:case GifScript.GifScriptState.ModifyRule.OverflowG:case GifScript.GifScriptState.ModifyRule.OverflowB:return this.checkOverflow(rules[channel]-GifScript.GifScriptState.ModifyRule.OverflowR|0,input,rules,parameters)?(result3=input[channel]+parameters[channel]|0,(result3<0||result3>255)&&(error.v=!0),result3&255):input[channel];case GifScript.GifScriptState.ModifyRule.Wrap255OverflowR:case GifScript.GifScriptState.ModifyRule.Wrap255OverflowG:case GifScript.GifScriptState.ModifyRule.Wrap255OverflowB:return this.checkOverflow(rules[channel]-GifScript.GifScriptState.ModifyRule.Wrap255OverflowR|0,input,rules,parameters)?(result4=input[channel]+parameters[channel]|0,result4&255):input[channel];case GifScript.GifScriptState.ModifyRule.Wrap272OverflowR:case GifScript.GifScriptState.ModifyRule.Wrap272OverflowG:case GifScript.GifScriptState.ModifyRule.Wrap272OverflowB:return this.checkOverflow(rules[channel]-GifScript.GifScriptState.ModifyRule.Wrap272OverflowR|0,input,rules,parameters)?(result5=input[channel]+parameters[channel]|0,result5%272&255):input[channel];default:return error.v=!0,0}},tryOverflowRule:function(rulesSoFar,parameters,examples,channel){for(var tryChannel,overflow0,overflow1,channelExampleA,channelExampleB,parameter,channelExamples=examples[channel],example0=System.Array.init([examples[0][0],examples[1][0],examples[2][0]],System.Byte),example1=System.Array.init([examples[0][1],examples[1][1],examples[2][1]],System.Byte),tryOrderIdx=0;tryOrderIdx<3;tryOrderIdx=tryOrderIdx+1|0)if(tryChannel=this.overflowTryOrder[tryOrderIdx],rulesSoFar[tryChannel]>=GifScript.GifScriptState.ModifyRule.Wrap255Add){if(overflow0=this.checkOverflow(tryChannel,example0,rulesSoFar,parameters),overflow1=this.checkOverflow(tryChannel,example1,rulesSoFar,parameters),overflow0!==(channelExamples[0]!==channelExamples[1]))break;if(overflow1!==(channelExamples[1]!==channelExamples[2]))break;if(overflow0===overflow1)break;return overflow0?(channelExampleA=channelExamples[0],channelExampleB=channelExamples[1]):(channelExampleA=channelExamples[1],channelExampleB=channelExamples[2]),parameter=rulesSoFar[tryChannel]>=GifScript.GifScriptState.ModifyRule.Wrap272Add?((channelExampleB+272|0)-channelExampleA|0)%272:((channelExampleB+256|0)-channelExampleA|0)%256,parameter>127?parameter=parameter-256|0:parameter<-128&&(parameter=parameter+256|0),parameters[channel]=parameter,(channelExampleA+parameter|0)!==channelExampleB?rulesSoFar[tryChannel]>=GifScript.GifScriptState.ModifyRule.Wrap272Add?GifScript.GifScriptState.ModifyRule.Wrap272OverflowR+tryChannel|0:GifScript.GifScriptState.ModifyRule.Wrap255OverflowR+tryChannel|0:GifScript.GifScriptState.ModifyRule.OverflowR+tryChannel|0}return GifScript.GifScriptState.ModifyRule.Unknown},checkOverflow:function(channel,RGB,rules,parameters){var newValue=RGB[channel]+parameters[channel]|0;switch(rules[channel]){case GifScript.GifScriptState.ModifyRule.Wrap255Add:case GifScript.GifScriptState.ModifyRule.Wrap272Add:return newValue<0||newValue>255;case GifScript.GifScriptState.ModifyRule.Wrap255OverflowR:case GifScript.GifScriptState.ModifyRule.Wrap272OverflowR:return this.checkOverflow(0,RGB,rules,parameters)?newValue<0||newValue>255:!1;case GifScript.GifScriptState.ModifyRule.Wrap255OverflowG:case GifScript.GifScriptState.ModifyRule.Wrap272OverflowG:return this.checkOverflow(1,RGB,rules,parameters)?newValue<0||newValue>255:!1;case GifScript.GifScriptState.ModifyRule.Wrap255OverflowB:case GifScript.GifScriptState.ModifyRule.Wrap272OverflowB:return this.checkOverflow(2,RGB,rules,parameters)?newValue<0||newValue>255:!1;default:return!1}}});Bridge.define("GifScript.GifScriptState.ModifyRule",{$kind:"enum",statics:{Unknown:0,CopyR:1,CopyG:2,CopyB:3,SetConstant:4,Invert:5,Add:6,OverflowR:7,OverflowG:8,OverflowB:9,Wrap255Add:10,Wrap255OverflowR:11,Wrap255OverflowG:12,Wrap255OverflowB:13,Wrap272Add:14,Wrap272OverflowR:15,Wrap272OverflowG:16,Wrap272OverflowB:17}});Bridge.define("GifScript.GifStackFrame",{lHSValue:null,rHSInstruction:0,config:{init:function(){this.runningRegister=new GifScript.ColorRGB}},ctor:function(runningRegister){this.$initialize();this.runningRegister=runningRegister.$clone();this.rHSInstruction=0},$ctor1:function(LHSValue,RHSInstruction,runningRegister){this.$initialize();this.lHSValue=LHSValue.GifScript$IGifValue$copy();this.rHSInstruction=RHSInstruction;this.runningRegister=runningRegister.$clone()}});Bridge.define("GifScript.GifCursor",{inherits:[GifScript.IGifValue],cube:null,config:{alias:["copy","GifScript$IGifValue$copy","read","GifScript$IGifValue$read","write","GifScript$IGifValue$write"],init:function(){this.register=new GifScript.ColorRGB;this.position=new GifScript.ColorRGB}},ctor:function(register,position,cube){this.$initialize();this.register=register.$clone();this.position=position.$clone();this.cube=cube},copy:function(){return new GifScript.GifCursor(this.register.$clone(),this.position.$clone(),this.cube)},read:function(){return this.cube.getItem(this.position)},write:function(color,error){error.v=!1;this.cube.setItem(this.position,color.$clone())}});Bridge.define("GifScript.GifValue_Readonly",{inherits:[GifScript.IGifValue],config:{alias:["copy","GifScript$IGifValue$copy","read","GifScript$IGifValue$read","write","GifScript$IGifValue$write"],init:function(){this.value=new GifScript.ColorRGB}},ctor:function(value){this.$initialize();this.value=value.$clone()},copy:function(){return new GifScript.GifValue_Readonly(this.value.$clone())},read:function(){return this.value.$clone()},write:function(color,error){error.v=!0}})});